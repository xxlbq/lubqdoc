
 各系统测试环境的数据库用户密码变更为
fxdev
bestwiz 



Ieq00001
00000007
111111111111

6666666666666666666666666

6666666666666666





UPDATE JHF_CUSTOMER_STATUS  SET LOGIN_PASSWORD='593c9b4a9390551d53e5cacf28ebd638' WHERE CUSTOMER_ID = '00000007';




10.4.9.115

PrG7lv2Y




mysql -h10.4.9.115 -uMAIN -pPrG7lv2Y -A MAIN 



SELECT * FROM JHF_CASH_BALANCE WHERE CASH_BALANCE =0 LIMIT 5\G;






                 CUSTOMER_ID: 00000007
                    GROUP_ID: DEFAULT
       WITHDRAWAL_CONSTRAINT: 0
              ACCOUNT_STATUS: 0
              ACCOUNT_MARGIN: 0
         RISK_ACCOUNT_STATUS: 0
            LOGIN_CONSTRAINT: 0
         OPEN_BUY_CONSTRAINT: 0
        OPEN_SELL_CONSTRAINT: 0
        CLOSE_BUY_CONSTRAINT: 0
       CLOSE_SELL_CONSTRAINT: 0
        STRADDLE_OPTION_FLAG: 0
       ACCOUNT_ACTIVE_STATUS: 0
  ACCOUNT_ACTIVE_STATUS_DATE: 20090622
                    LOGIN_ID: Ieq00001
              LOGIN_PASSWORD: 81b2dd41e910bb699f20dfb828d01a5f
          OLD_LOGIN_PASSWORD: 81b2dd41e910bb699f20dfb828d01a5f
          ORIGINAL__PASSWORD: QWJveUNyblA=
        PASSWORD_UPDATE_DATE: 20090622











2009-05-26 11:20:29,600 INFO  [trader.business.TradeChecker#sendToCover:1254] :  send to cover : coverRequestInfo  = cn.best
wiz.jhf.core.jms.bean.CoverRequestInfo[amount=10000.00,tradeAskPrice=132.419,tradeBidPrice=132.372,side=-1,,mode=-1currencyP
air=EUR/JPY,orderBindId=2009052600009910,tradeDate=20090526,exectionType=99,priceId=20090526VIRCPPDeb24e8bb-5ce6-4dc3-98ba-9
5649e04c3dd,stopOrderFlag=0orderid=null]]
2009-05-26 11:20:30,112 INFO  [trader.job.TradeResultJob#mainProcess:80] : === [Trade Result Job] ===  tradeResultInfo :cn.b
estwiz.jhf.core.jms.bean.TradeResultInfo[amount=10000.00,counterpartyId=DB,currencyPair=EUR/JPY,dealerBindId=null,dealerCode
=null,destFlag=1,errorcode=null,errormsg=null,executionId=[20090526CPEX00003239],operationFlag=[1],side=-1,tradeDate=2009052
6,TradeBidPrice=132.372,TradeAskPrice=132.419,cpExecutionAskPrice=null,cpExecutionBidPrice=132.371,valueDate=20090528,orderB
indId=2009052600009910,successflag=1,id=20090526COVR00192238,ExectionType=99,mode=-1,priceId=20090526VIRCPPDeb24e8bb-5ce6-4d
c3-98ba-95649e04c3ddhedgeType=-1,hedgedOrderMap={20090526ORD00008629=10000.00},stopOrderFlag=0,
2009-05-26 11:20:30,113 INFO  [trader.business.ExecWriter#disposeCpExecutionPrice:1377] : after dispose CpExecutionPrice cn.
bestwiz.jhf.core.jms.bean.TradeResultInfo[amount=10000.00,counterpartyId=DB,currencyPair=EUR/JPY,dealerBindId=null,dealerCod
e=null,destFlag=1,errorcode=null,errormsg=null,executionId=[20090526CPEX00003239],operationFlag=[1],side=-1,tradeDate=200905
26,TradeBidPrice=132.372,TradeAskPrice=132.419,cpExecutionAskPrice=null,cpExecutionBidPrice=132.371,valueDate=20090528,order
BindId=2009052600009910,successflag=1,id=20090526COVR00192238,ExectionType=99,mode=-1,priceId=20090526VIRCPPDeb24e8bb-5ce6-4
dc3-98ba-95649e04c3ddhedgeType=-1,hedgedOrderMap={20090526ORD00008629=10000.00},stopOrderFlag=0,
2009-05-26 11:20:30,113 INFO  [trader.job.TradeResultJob#mainProcess:275] : === [Trade Result Job] ===  After Remove OrderBi
ndId [2009052600009910] Cache Size is 1
2009-05-26 11:20:30,113 INFO  [trader.job.TradeResultJob#mainProcess:277] : After Remove OrderBindId [2009052600009910] KEY 
:2009052600009910,VALUE:cn.bestwiz.jhf.core.bo.bean.OrderBindInfo@245dd0[isBlackOrder=false,tradeAskPrice=132.419,mobileFlag
=false,slipConfigType=-1,priceId=20090526VIRCPPDeb24e8bb-5ce6-4dc3-98ba-95649e04c3dd,type=99,stopOrderFlag=0,currencyPair=EU
R/JPY,mode=NORMAL,amount=10000.00,tradeDate=<null>,customerId=<null>,tradeBidPrice=132.372,side=-1,orderBindId=2009052600009
910,slippage=<null>,frontId=<null>,orderMap{={20090526ORD00008629=cn.bestwiz.jhf.core.bo.bean.FillingOrderInfo@10e47b3[trade
Type=0,executionDate=<null>,activationDate=2009-05-26 11:18:19.0,currencyPair=EUR/JPY,customerId=00000901,orderAmount=10000.
00,side=-1,parentOrderId=<null>,expirationType=-1,ocoOrderId=<null>,contractId=<null>,agentStaffId=system,customerOrderNumbe
r=T000000063,orderId=20090526ORD00008629,revisionNumber=3,expirationDate=2009-05-27 05:50:00.0,orderType=0,orderDate=2009052
6,orderRoute=4,forceRelationId=T000000063,tradeID=20090526TRAD00008629,updateStaffId=system,orderTime=111819,priceId=2009052
6VIRCPPDc4e2b66f-a0cc-43d7-ae77-dc01d2692b8b,orderStatus=1,productId=C002,losscutOrderFlag=0,slippage=0.100000,executionType
=12,orderPrice=132.426000,orderDatetime=2009-05-26 11:18:19.0]},}]
2009-05-26 11:20:30,138 INFO  [trader.business.ExecWriter#calcFinalCustomerPrice:1168] : before calcFinalCustomerPrice() par
am : orderId:20090526ORD00008629,currencyPair:EUR/JPY,tradeRstInfoSide:-1,orderInfoSide:-1,resultTradeAsk:132.419,resultTrad
eBid:132.372,cpAsk:null,cpBid:132.371,orderInfoPriceId:20090526VIRCPPDeb24e8bb-5ce6-4dc3-98ba-95649e04c3dd
2009-05-26 11:20:30,142 INFO  [trader.business.ExecWriter#calcFinalCustomerPriceByInfo:1257] : after add spread ,side:-1 ,cu
stTraderPrice:132.372 ,pair:EUR/JPY ,cpExePriceWithSpread:132.371000
2009-05-26 11:20:30,142 INFO  [trader.business.ExecWriter#calcFinalCustomerPriceByInfo:1281] : return customerPrice=132.3710
00
2009-05-26 11:20:30,142 INFO  [trader.business.ExecWriter#calcFinalCustomerPrice:1202] : after calcFinalCustomerPrice() para
m : orderId:20090526ORD00008629,currencyPair:EUR/JPY,tradeRstInfoSide:-1,orderInfoSide:-1,resultTradeAsk:132.419,resultTrade
Bid:132.372,cpAsk:null,cpBid:132.371,orderBindPriceId:null,finalCustomerPrice:132.371000
2009-05-26 11:20:30,143 INFO  [bo.contructor.PositionInfoFactory#createPositionInfo:102] :  IdGenerateFacade Get Id Begin . 
orderId=20090526ORD00008629
2009-05-26 11:20:30,143 INFO  [bo.contructor.PositionInfoFactory#createPositionInfo:122] :  IdGenerateFacade Get Id End . Us
e Time =1(millseconds).orderId=20090526ORD00008629















	public CustTradePolicy getHedgeCustTradeMode(String currencyPair, int side, int executionType,
			BigDecimal amount ,boolean isMoble,String id ) throws Exception{
		//默认为通常模式
		int retMode = CustTraderModeEnum.NORMAL_MODE_ENUM.getValue();
		//默认slipConfigType为 -1 
		int slipConfigType = SlipConfigTypeEnum.DEFAULT_ENUM.getValue();
		//默认stayPlace为0
		int stayPlace = StayTypeEnum.STAY_TYPE_DEFALT_ENUM.getValue(); 
		
		try {
			JhfCusttradeContrl custControl = 
ServiceFactory.getConfigService().obtainJhfCusttradeContrl(currencyPair,amount);
			JhfStatusContrl control = 
ServiceFactory.getConfigService().obtainStatusContrl(currencyPair);		
			//默认滞留开关为OFF
			boolean isStayOn = false;
			//总开关从 JhfCusttradeContrl 中取 ，注文种别开关从 JhfStatusContrl中取。 
			isStayOn = (custControl.getAutohedgeSwatich().intValue() == AutoHedgeSwitchEnum.ON_ENUM.getValue());
			m_log.info(" JhfCusttradeContrl : isAutohedgeSwatichOn=" + isStayOn + ",id=" +id);
			
			//on状态
			if(isStayOn){
				isStayOn = false;
				/**判断注文类型**/
				//如果是instants注文（非mobile）
				if ((executionType == ExecutionTypeEnum.EXEC_INSTANT_ENUM.getValue() 
						|| executionType == ExecutionTypeEnum.EXEC_BATCH_REALTIME_ENUM.getValue()) ){
					
					if (side == SideEnum.SIDE_BUY.getValue()) {
						isStayOn = ( control.getAutohedgeMarketBuy().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue() );
					} else {
						isStayOn = ( control.getAutohedgeMarketSell().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue());
					}
					
					//如果不是mobile注文（flash成行，一括注文）
					if( ! isMoble){
						//如果滞留开关为On ,instants(非mobile)  取 	InstantPriceSwatich
						if(isStayOn){
							retMode 	= custControl.getInstantPriceSwatich().intValue();
							stayPlace	= custControl.getInstant1StayPlace().intValue();
						}
						//如果retMode为 slippage滞留 或 slippage 1lot滞留 则查询 InstantSlipConfigType
的配置
						if(isSlippageMode(retMode)){
							slipConfigType = custControl.getInstantSlipConfigType().intValue();
						}
						
					//如果是mobile注文	
					}else{
						//如果滞留开关为On ,mobile  取 	InstantPriceSwatich2
						if(isStayOn){
							retMode 	= custControl.getInstantPriceSwatich2().intValue();
							stayPlace 	= custControl.getInstant2StayPlace().intValue();
						}
						//如果retMode为 slippage滞留 或 slippage 1lot滞留 则查询 InstantSlipConfigType2
的配置
						if(isSlippageMode(retMode)){
							slipConfigType = custControl.getInstantSlipConfigType2().intValue();
						}
					}

				}else
				//如果是 紧急决计 注文
				if(executionType == ExecutionTypeEnum.EMERGENCY_SETTLE_ENUM.getValue()){
					if (side == SideEnum.SIDE_BUY.getValue()) {
						isStayOn = ( control.getAutohedgeMarketBuy().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue() );
					} else {
						isStayOn = ( control.getAutohedgeMarketSell().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue());
					}

					//如果滞留开关为On ,紧急决计  取 InstantPriceSwatich2
					if(isStayOn){
						retMode 	= custControl.getInstantPriceSwatich2().intValue();
						stayPlace 	= custControl.getInstant2StayPlace().intValue();
					}
					//如果retMode为 slippage滞留 或 slippage 1lot滞留 则查询 InstantSlipConfigType2的配置
					if(isSlippageMode(retMode)){
						slipConfigType = custControl.getInstantSlipConfigType2().intValue();
					}
				
				}else
				//时间成行取 开关取 InstantPriceSwatich2，配置取 InstantSlipConfigType2
				if(executionType == ExecutionTypeEnum.TIMEORDER_ENUM.getValue()){
					if (side == SideEnum.SIDE_BUY.getValue()) {
						isStayOn = ( control.getAutohedgeMarketBuy().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue() );
					} else {
						isStayOn = ( control.getAutohedgeMarketSell().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue());
					}
				
					//如果滞留开关为On ,紧急决计  取 InstantPriceSwatich2
					if(isStayOn){
						retMode 	= custControl.getInstantPriceSwatich2().intValue();
						stayPlace 	= custControl.getInstant2StayPlace().intValue();
					}
					//如果retMode为 slippage滞留 或 slippage 1lot滞留 则查询 InstantSlipConfigType2的配置
					if(isSlippageMode(retMode)){
						slipConfigType = custControl.getInstantSlipConfigType2().intValue();
					}

				}else
				//LIMIT 注文
				if (executionType ==  ExecutionTypeEnum.EXEC_LIMIT_ENUM.getValue()) {
						if (side == SideEnum.SIDE_BUY.getValue()) {
							isStayOn = ( control.getAutohedgeLimitBuy().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue() );
						} else {
							isStayOn = ( control.getAutohedgeLimitSell().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue());
						}
						//如果滞留开关为On ，	
						if(isStayOn){
							retMode 	= custControl.getLimitPriceSwatich().intValue();
							stayPlace 	= custControl.getLimitStayPlace().intValue();
						}
						
				} else
				//STOP 注文	
				if (executionType ==  ExecutionTypeEnum.EXEC_STOP_ENUM.getValue()){
						if (side == SideEnum.SIDE_BUY.getValue()) {
							isStayOn = ( control.getAutohedgeStopBuy().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue() );
						} else {
							isStayOn = ( control.getAutohedgeStopSell().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue());
						}
						//如果滞留开关为On ，	
						if(isStayOn){
							retMode 	= custControl.getStopPriceSwatich().intValue();
							stayPlace 	= custControl.getStopStayPlace().intValue();
						}
						
				} else 
				//LOSSCUT 注文
				if (executionType ==  ExecutionTypeEnum.EXEC_LOSS_CUT_ENUM.getValue()) {
						if (side == SideEnum.SIDE_BUY.getValue()) {
							isStayOn = ( control.getAutohedgeLosscutBuy().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue() );
						} else {
							isStayOn = ( control.getAutohedgeLosscutSell().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue());
						}
						//如果滞留开关为On ，	
						if(isStayOn){
							retMode 	= custControl.getLosscutPriceSwatich().intValue();
							stayPlace 	= custControl.getLosscutStayPlace().intValue();
						}
						//[losscut注文处理也添加了 slip config 设定]  如果retMode为 slippage滞留 或 
slippage 1lot滞留 则查询
						if(isSlippageMode(retMode)){
							slipConfigType = custControl.getLosscutSlipConfigType().intValue();
						}
				}
			}
			
			m_log.info(" after order executionType check ,isStayOn=" + isStayOn 
					+ ",mode=" + CustTraderModeEnum.getEnum(retMode).getName() + ",slipConfigType=" + 
slipConfigType 
					+ ",amount=" + amount + ",stayPlace=" + stayPlace + ",id=" + id );

			if( isSlippageMode(retMode) && (slipConfigType == SlipConfigTypeEnum.DEFAULT_ENUM.getValue()) ){
				throw new CoreException(" mode="+ CustTraderModeEnum.getEnum(retMode).getName() + 
",slipConfigType="+slipConfigType+",id=" +id );
			}
			
			if( canStay2Mode(retMode) && (stayPlace == StayTypeEnum.STAY_TYPE_2_ENUM.getValue()) ){
				throw new CoreException(" mode="+ CustTraderModeEnum.getEnum(retMode).getName() + 
",stayPlace="+stayPlace+",id=" +id );
			}
			
			// 如果mode 为非 同期模式 则为滞留模式（包括几种滞留方式）   判断EOD直前滞留停止rg EOD直前滞留停止r
g的开关
			if ( isStayMode(retMode) && 
					(control.getStopTimeBeforeEodSwitch().intValue() == 
BoolEnum.BOOL_YES_ENUM.getValue())) {
				
				JhfApplicationDate date = this.getApplicationDate(DateKeyEnum.FRONT_DATE_KEY_ENUM.getName());

				long beforeTime = control.getStopTimeBeforeEod().longValue() * 1000 * 60;
				// 取得当前系统时间
				long currDateTime = System.currentTimeMillis();
				long eodDateTime = date.getNextEodStartTime().getTime();
				
				if (currDateTime >= eodDateTime - beforeTime) {
					retMode = CustTraderModeEnum.NORMAL_MODE_ENUM.getValue();
					m_log.info("mode ="+CustTraderModeEnum.getEnum(retMode).getName()+" After EOD 
beforeTime Check  mode is Normal ! id=" + id);
				}
			}
			
		} catch (Exception e) {
			m_log.error("getHedgeCustTradeMode error ! id=" + id + ",amount=" + amount,e);
			throw new CoreException("getHedgeCustTradeMode error !!");
		}
		
		
		CustTradePolicy omInfo =new CustTradePolicy();
		omInfo.setMode(retMode);
		omInfo.setSlipConfigType(slipConfigType);
		omInfo.setStayPlace(stayPlace);
		
		m_log.info(" after HedgeCustTradeMode check ,mode=" + CustTraderModeEnum.getEnum(omInfo.getMode()).getName() 
				+ ",SlipConfigType=" + omInfo.getSlipConfigType() + ",StayPlace=" + stayPlace + ",id=" +id);
		
		return omInfo;
	}



















删除src/cn/bestwiz/jhf/core/bo/enums/StayPositionTypeEnum.java;
src/cn/bestwiz/jhf/core/bo/enums/CustTraderModeEnum.java
src/cn/bestwiz/jhf/core/bo/bean/PositionInfo.java
添加src/cn/bestwiz/jhf/core/bo/bean/CustTradePolicy.java
src/cn/bestwiz/jhf/core/bo/bean/OrderBindInfo.java
删除src/cn/bestwiz/jhf/core/bo/bean/InstantsOrderModeInfo.java
src/cn/bestwiz/jhf/core/bo/contructor/PositionInfoFactory.java

src/cn/bestwiz/jhf/core/service/CoreService.java	 
src/cn/bestwiz/jhf/core/custtrade/FillOrderServiceImpl.java
 src/cn/bestwiz/jhf/trader/ros/RepairOrderService.java
src/cn/bestwiz/jhf/trader/trader/business/RiskControlOrderProcessor.java
src/cn/bestwiz/jhf/trader/trader/business/ExecWriter.java


frontdesk

src/cn/bestwiz/jhf/frontdesk/lib/allSettle/AllSettleApartService.java
src/cn/bestwiz/jhf/frontdesk/agent/OrderAgent.java
src/cn/bestwiz/jhf/frontdesk/trade/biz/util/OrderUtilty.java


重命名

Checking in src/cn/bestwiz/jhf/core/service/DispatchService.java

 src/cn/bestwiz/jhf/core/service/dispatch/RealTimeOrder.java

 src/cn/bestwiz/jhf/trader/ewp/to/business/TimeOrderService.java

src/cn/bestwiz/jhf/trader/riskcontrol/processor/RiskControlCutOrderAndSettleContract.java

src/cn/bestwiz/jhf/trader/losscut/processor/LossCutOpenOrderAndSettleOrder.java





各位，针对课题：all 215  对于特定的注文Ne的lot不进行滞留，另外进行管理

core ，trader工程里相关的类，方法有一些变化。

1.类InstantsOrderModeInfo ===》 更名变为 CustTradePolicy

在调用
coreService.getTradeModeForInstantsOrder 
coreService.getTradeModeForLossOrder 
coreService.getTradeModeForOthers 
coreService.getTradeModeForRiskOrder 

方法时  返回值为 CustTradePolicy（原来为InstantsOrderModeInfo）

				新加一个属性 滞留地点 ：(int stayPlace = ctp.getStayPlace();)



CustTradePolicy ctp = coreService.getTradeModeForInstantsOrder （。。。）；//如果要获得属性 ===> ctp.getxxx()

原来的逻辑：
aaa = ctp.geta（）；
bbb = ctp.getb（）；
。。。

orderbindinfo.set (aaa)
orderbindinfo.set (bbb)
。。。

现在：
aaa = ctp.geta（）；//去掉
bbb = ctp.getb（）；//去掉
。。。//去掉

orderbindinfo.set (aaa)//去掉
orderbindinfo.set (bbb)//去掉
。。。//去掉

orderbindinfo.setCustTradePolicy(ctp) //添加



