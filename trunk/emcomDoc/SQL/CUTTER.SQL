//20110326
//进行数据取消前，执行下面的SQL，用于变更数据的统计

--ALL 1214,MAIN Master

--//决计注文（注文中）
SELECT CURRENCY_PAIR,COUNT(*) AS COUNT,SUM(ORDER_AMOUNT)  AS ORDER_AMOUNT  FROM   JHF_ALIVE_ORDER 
WHERE  ORDER_STATUS IN (0,1) AND ACTIVE_FLAG=1
AND CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR')
GROUP BY CURRENCY_PAIR;

--//对应的持仓还原
SELECT CURRENCY_PAIR,COUNT(*) AS COUNT,SUM(AMOUNT_NO_SETTLED) AS AMOUNT_NO_SETTLED, SUM(AMOUNT_SETTLING) AS AMOUNT_SETTLING FROM  JHF_ALIVE_CONTRACT
WHERE (AMOUNT-AMOUNT_SETTLED)>0 AND AMOUNT_SETTLING>0 AND ACTIVE_FLAG=1
AND CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR')
GROUP BY CURRENCY_PAIR;


UPDATE JHF_PRODUCT SET CLOSE_BUY_CONSTRAINT=3,CLOSE_SELL_CONSTRAINT=3  WHERE CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR');
DELETE FROM JHF_RATE_MAIL  WHERE CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR');

UPDATE JHF_ALIVE_ORDER SET 
ORDER_STATUS=2,CHANNEL_ID='SYSTEM',UPDATE_DATE=NOW(),MEMO='Order cancellation by the system'
WHERE  ORDER_STATUS IN (0,1) AND ACTIVE_FLAG=1
AND CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR');

UPDATE JHF_ALIVE_CONTRACT SET
AMOUNT_SETTLING=0,
UPDATE_DATE=NOW()
WHERE (AMOUNT-AMOUNT_SETTLED)>0 AND AMOUNT_SETTLING>0 AND ACTIVE_FLAG=1
AND CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR');


//数据取消后，利用下面的SQL进行检查，结果为0，表示正确
SELECT COUNT(*) FROM JHF_ALIVE_ORDER WHERE  ORDER_STATUS IN (0,1) AND ACTIVE_FLAG=1  
AND CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR');

SELECT COUNT(*) FROM JHF_ALIVE_CONTRACT WHERE AMOUNT_SETTLING>0 AND 
CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR');

16:10
(2011-03-25 16:11:35) 王岩: 

mysql> select count(*) from JHF_ALIVE_CONTRACT where amount_no_settled>0 and 
    -> CURRENCY_PAIR IN ('EUR/AUD','GBP/AUD','EUR/NZD','GBP/NZD','AUD/NZD','EUR/CAD','GBP/CAD','AUD/CAD','NZD/CAD','EUR/CHF','GBP/CHF','AUD/CHF','NZD/CHF','CAD/CHF','USD/ZAR','EUR/ZAR','GBP/ZAR')
    -> ;
+----------+
| count(*) |
+----------+
|        0 |
+----------+
1 row in set (0.46 sec)